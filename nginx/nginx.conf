events {}

http {
  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  client_max_body_size 50m;
  sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65;
  map $http_upgrade $connection_upgrade { default upgrade; '' close; }

  # 80: ACME만 통과, 나머지는 https로 리다이렉트
  server {
    listen 80 default_server;
    server_name voiz2b.link;

    location ^~ /.well-known/acme-challenge/ {
      root /usr/share/nginx/html;
      default_type "text/plain";
      try_files $uri =404;
    }

    location / {
      return 301 https://$host$request_uri;
    }
  }

  # 443: 실제 서비스
  server {
    listen 443 ssl default_server;
    http2 on;
    server_name voiz2b.link;

    ssl_certificate     /etc/letsencrypt/live/voiz2b.link/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/voiz2b.link/privkey.pem;

    # (선택) 443에서도 ACME 통과
    location ^~ /.well-known/acme-challenge/ {
      root /usr/share/nginx/html;
      default_type "text/plain";
      try_files $uri =404;
    }

    # 정적 웹
    root /usr/share/nginx/html;
    index index.html;
    location / { try_files $uri $uri/ /index.html; }

    # API 프록시  (/api → 백엔드 / 로 전달; 끝의 슬래시 필수)
    location /api/ {
      proxy_pass http://api:8000/;   # ← /api 프리픽스 제거되어 /health, /process 등으로 전달됨
      proxy_http_version 1.1;
      proxy_request_buffering off;
      proxy_buffering on;
      proxy_buffers 16 64k;
      proxy_busy_buffers_size 128k;
      proxy_read_timeout 3600;
      proxy_send_timeout 3600;

      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket 매핑 (/api/ws → 백엔드 /ws 로 전달)
    location /api/ws/ {
      proxy_pass http://api:8000/ws/;  # ← /api/ws 를 /ws 로 매핑
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      proxy_read_timeout 3600;

      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    gzip on;
    gzip_types text/plain text/css application/javascript application/json application/xml;
  }
}
